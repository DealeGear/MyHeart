<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Monitor Cardíaco Virtual</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos globais */
        :root {
            --bg-color: #000;
            --text-color: #0f0;
            --ecg-color: #0f0;
            --bp-color: #f00;
            --spo2-color: #00f;
            --rr-color: #ff0;
            --panel-bg: rgba(0, 20, 0, 0.7);
            --border-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Cabeçalho */
        header {
            background-color: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 1.5rem;
            color: var(--text-color);
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        button {
            background-color: #222;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
        }

        button:hover {
            background-color: #333;
        }

        button.active {
            background-color: var(--text-color);
            color: var(--bg-color);
        }

        /* Conteúdo principal */
        main {
            flex: 1;
            display: flex;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        /* Painel de gráficos */
        .charts-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chart-container {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            flex: 1;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .chart-title {
            font-weight: bold;
        }

        .chart-select {
            background-color: #222;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 3px;
        }

        /* Painel de parâmetros */
        .parameters-panel {
            width: 250px;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .parameter {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .parameter-name {
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .parameter-value {
            color: var(--text-color);
        }

        input[type="range"] {
            width: 100%;
        }

        .parameter-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
        }

        /* Painel de indicadores */
        .indicators-panel {
            width: 300px;
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .indicator {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .indicator-name {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .indicator-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .indicator-unit {
            font-size: 1rem;
        }

        .hr-indicator {
            color: var(--ecg-color);
        }

        .bp-indicator {
            color: var(--bp-color);
        }

        .spo2-indicator {
            color: var(--spo2-color);
        }

        .rr-indicator {
            color: var(--rr-color);
        }

        .rhythm-indicator {
            background-color: rgba(0, 100, 0, 0.3);
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* Painel de controle */
        .control-panel {
            background-color: var(--panel-bg);
            border-top: 1px solid var(--border-color);
            padding: 10px;
            display: flex;
            gap: 15px;
            overflow-x: auto;
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }

        .control-title {
            font-weight: bold;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 3px;
            margin-bottom: 5px;
        }

        .presets {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .preset-btn {
            padding: 5px;
            font-size: 0.8rem;
            flex: 1;
            min-width: 80px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle {
            position: relative;
            width: 40px;
            height: 20px;
            background-color: #333;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle.active {
            background-color: var(--text-color);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background-color: #111;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle.active .toggle-slider {
            transform: translateX(20px);
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Responsividade */
        @media (max-width: 1200px) {
            .parameters-panel, .indicators-panel {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            
            .parameters-panel, .indicators-panel {
                width: 100%;
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Simulador de Monitor Cardíaco Virtual</h1>
        <div class="header-controls">
            <button id="resetBtn">Reset</button>
            <button id="pauseBtn">Pausar</button>
            <div class="toggle-container">
                <span>Som</span>
                <div id="soundToggle" class="toggle active">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="toggle-container">
                <span>Reflexo</span>
                <div id="baroreflexToggle" class="toggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <section class="charts-panel">
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">ECG - Derivação II</span>
                    <span>25 mm/s</span>
                </div>
                <canvas id="ecgChart"></canvas>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <span class="chart-title">Parâmetro Hemodinâmico</span>
                    <select id="parameterSelect" class="chart-select">
                        <option value="bp">Pressão Arterial (mmHg)</option>
                        <option value="spo2">SpO₂ (%)</option>
                        <option value="rr">Frequência Respiratória (irpm)</option>
                    </select>
                </div>
                <canvas id="parameterChart"></canvas>
            </div>
        </section>

        <section class="indicators-panel">
            <div class="indicator hr-indicator">
                <div class="indicator-name">Frequência Cardíaca</div>
                <div class="indicator-value"><span id="hrValue">75</span> <span class="indicator-unit">bpm</span></div>
            </div>
            <div class="indicator bp-indicator">
                <div class="indicator-name">Pressão Arterial</div>
                <div class="indicator-value">
                    <span id="bpValue">120/80</span> <span class="indicator-unit">mmHg</span>
                </div>
                <div class="indicator-value">
                    MAP: <span id="mapValue">93</span> <span class="indicator-unit">mmHg</span>
                </div>
            </div>
            <div class="indicator spo2-indicator">
                <div class="indicator-name">Saturação de O₂</div>
                <div class="indicator-value"><span id="spo2Value">98</span> <span class="indicator-unit">%</span></div>
            </div>
            <div class="indicator rr-indicator">
                <div class="indicator-name">Frequência Respiratória</div>
                <div class="indicator-value"><span id="rrValue">16</span> <span class="indicator-unit">irpm</span></div>
            </div>
            <div class="rhythm-indicator">
                Ritmo: <span id="rhythmValue">NSR</span>
            </div>
        </section>
    </main>

    <section class="control-panel">
        <div class="control-section">
            <div class="control-title">Parâmetros Fisiológicos</div>
            <div class="parameter">
                <div class="parameter-name">
                    <span>Frequência Cardíaca</span>
                    <span class="parameter-value"><span id="hrSliderValue">75</span> bpm</span>
                </div>
                <input type="range" id="hrSlider" min="30" max="220" value="75">
                <div class="parameter-display">
                    <span>30</span>
                    <span>220</span>
                </div>
            </div>
            <div class="parameter">
                <div class="parameter-name">
                    <span>Contractilidade</span>
                    <span class="parameter-value"><span id="contractilitySliderValue">100</span>%</span>
                </div>
                <input type="range" id="contractilitySlider" min="0" max="200" value="100">
                <div class="parameter-display">
                    <span>0%</span>
                    <span>200%</span>
                </div>
            </div>
            <div class="parameter">
                <div class="parameter-name">
                    <span>Pré-carga</span>
                    <span class="parameter-value"><span id="preloadSliderValue">100</span>%</span>
                </div>
                <input type="range" id="preloadSlider" min="0" max="200" value="100">
                <div class="parameter-display">
                    <span>0%</span>
                    <span>200%</span>
                </div>
            </div>
            <div class="parameter">
                <div class="parameter-name">
                    <span>Pós-carga</span>
                    <span class="parameter-value"><span id="afterloadSliderValue">100</span>%</span>
                </div>
                <input type="range" id="afterloadSlider" min="0" max="200" value="100">
                <div class="parameter-display">
                    <span>0%</span>
                    <span>200%</span>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="control-title">Outros Parâmetros</div>
            <div class="parameter">
                <div class="parameter-name">
                    <span>FiO₂</span>
                    <span class="parameter-value"><span id="fio2SliderValue">21</span>%</span>
                </div>
                <input type="range" id="fio2Slider" min="10" max="100" value="21">
                <div class="parameter-display">
                    <span>10%</span>
                    <span>100%</span>
                </div>
            </div>
            <div class="parameter">
                <div class="parameter-name">
                    <span>Volume Sanguíneo</span>
                    <span class="parameter-value"><span id="volumeSliderValue">100</span>%</span>
                </div>
                <input type="range" id="volumeSlider" min="50" max="120" value="100">
                <div class="parameter-display">
                    <span>50%</span>
                    <span>120%</span>
                </div>
            </div>
            <div class="parameter">
                <div class="parameter-name">
                    <span>Frequência Respiratória</span>
                    <span class="parameter-value"><span id="rrSliderValue">16</span> irpm</span>
                </div>
                <input type="range" id="rrSlider" min="8" max="30" value="16">
                <div class="parameter-display">
                    <span>8</span>
                    <span>30</span>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="control-title">Arritmias</div>
            <select id="arrhythmiaSelect" class="chart-select">
                <option value="nsr">Ritmo Sinusal Normal</option>
                <option value="sinustachy">Taquicardia Sinusal</option>
                <option value="sinusbrady">Bradicardia Sinusal</option>
                <option value="afib">Fibrilação Atrial</option>
                <option value="aflutter">Flutter Atrial</option>
                <option value="pvc">Extrassístoles Ventriculares</option>
                <option value="bigeminy">Bigeminismo</option>
                <option value="vtach">Taquicardia Ventricular</option>
                <option value="avblock1">Bloqueio AV 1º Grau</option>
                <option value="avblock2">Bloqueio AV 2º Grau</option>
                <option value="avblock3">Bloqueio AV 3º Grau</option>
            </select>
            <div class="toggle-container">
                <span>Isquemia/Hipóxia</span>
                <div id="ischemiaToggle" class="toggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="volume-control">
                <span>Volume</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="50">
            </div>
        </div>

        <div class="control-section">
            <div class="control-title">Presets</div>
            <div class="presets">
                <button class="preset-btn" data-preset="normal">Normal</button>
                <button class="preset-btn" data-preset="tachy">Taquicardia</button>
                <button class="preset-btn" data-preset="brady">Bradicardia</button>
                <button class="preset-btn" data-preset="afib">FA</button>
                <button class="preset-btn" data-preset="vtach">TV</button>
                <button class="preset-btn" data-preset="hypovolemia">Hipovolemia</button>
                <button class="preset-btn" data-preset="hypoxia">Hipóxia</button>
            </div>
        </div>
    </section>

    <script>
        // Variáveis globais
        let ecgChart, parameterChart;
        let ecgData = [];
        let bpData = [];
        let spo2Data = [];
        let rrData = [];
        let animationId;
        let isPaused = false;
        let soundEnabled = true;
        let baroreflexEnabled = false;
        let currentParameter = 'bp';
        let audioContext;
        let s1Sound, s2Sound;
        let lastBeatTime = 0;
        let beatInterval = 600; // ms (60 bpm)
        let nextBeatTime = 0;
        let isPlayingS1 = true;
        let irregularRhythm = false;
        let irregularityFactor = 0;
        let avDelay = 150; // ms (normal AV conduction)
        let stSegmentElevation = 0; // mV

        // Parâmetros fisiológicos
        let heartRate = 75; // bpm
        let contractility = 100; // %
        let preload = 100; // %
        let afterload = 100; // %
        let fio2 = 21; // %
        let bloodVolume = 100; // %
        let respiratoryRate = 16; // irpm
        let spo2 = 98; // %
        let systolicBP = 120; // mmHg
        let diastolicBP = 80; // mmHg
        let meanArterialPressure = 93; // mmHg
        let strokeVolume = 70; // mL
        let cardiacOutput = 5.25; // L/min
        let systemicVascularResistance = 14; // mmHg/L/min

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            initAudio();
            initCharts();
            initEventListeners();
            updateCalculations();
            startAnimation();
        });

        // Inicialização do áudio
        function initAudio() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Criar sons S1 e S2
            s1Sound = createHeartSound(60, 0.1, 0.05); // Frequência mais baixa para S1
            s2Sound = createHeartSound(100, 0.08, 0.04); // Frequência mais alta para S2
        }

        // Criar som de batimento cardíaco
        function createHeartSound(frequency, duration, volume) {
            return function(time) {
                if (!soundEnabled) return;
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = 'sine';
                oscillator.frequency.value = frequency;
                
                gainNode.gain.value = volume * (document.getElementById('volumeSlider').value / 100);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(time);
                oscillator.stop(time + duration);
            };
        }

        // Inicialização dos gráficos
        function initCharts() {
            // Configuração do gráfico ECG
            const ecgCtx = document.getElementById('ecgChart').getContext('2d');
            ecgChart = new Chart(ecgCtx, {
                type: 'line',
                data: {
                    labels: Array(100).fill(''),
                    datasets: [{
                        label: 'ECG',
                        data: Array(100).fill(0),
                        borderColor: '#0f0',
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        x: {
                            display: false,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: false,
                            min: -0.5,
                            max: 1.5,
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });

            // Configuração do gráfico de parâmetros
            const parameterCtx = document.getElementById('parameterChart').getContext('2d');
            parameterChart = new Chart(parameterCtx, {
                type: 'line',
                data: {
                    labels: Array(100).fill(''),
                    datasets: [{
                        label: 'Pressão Arterial',
                        data: Array(100).fill(0),
                        borderColor: '#f00',
                        borderWidth: 1,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        x: {
                            display: false,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            display: false,
                            min: 0,
                            max: 200,
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
        }

        // Inicialização dos ouvintes de eventos
        function initEventListeners() {
            // Controles do cabeçalho
            document.getElementById('resetBtn').addEventListener('click', resetSimulation);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            
            // Toggles
            document.getElementById('soundToggle').addEventListener('click', toggleSound);
            document.getElementById('baroreflexToggle').addEventListener('click', toggleBaroreflex);
            document.getElementById('ischemiaToggle').addEventListener('click', toggleIschemia);
            
            // Sliders
            document.getElementById('hrSlider').addEventListener('input', function() {
                heartRate = parseInt(this.value);
                document.getElementById('hrSliderValue').textContent = heartRate;
                updateCalculations();
                updateBeatInterval();
            });
            
            document.getElementById('contractilitySlider').addEventListener('input', function() {
                contractility = parseInt(this.value);
                document.getElementById('contractilitySliderValue').textContent = contractility;
                updateCalculations();
            });
            
            document.getElementById('preloadSlider').addEventListener('input', function() {
                preload = parseInt(this.value);
                document.getElementById('preloadSliderValue').textContent = preload;
                updateCalculations();
            });
            
            document.getElementById('afterloadSlider').addEventListener('input', function() {
                afterload = parseInt(this.value);
                document.getElementById('afterloadSliderValue').textContent = afterload;
                updateCalculations();
            });
            
            document.getElementById('fio2Slider').addEventListener('input', function() {
                fio2 = parseInt(this.value);
                document.getElementById('fio2SliderValue').textContent = fio2;
                updateCalculations();
            });
            
            document.getElementById('volumeSlider').addEventListener('input', function() {
                bloodVolume = parseInt(this.value);
                document.getElementById('volumeSliderValue').textContent = bloodVolume;
                updateCalculations();
            });
            
            document.getElementById('rrSlider').addEventListener('input', function() {
                respiratoryRate = parseInt(this.value);
                document.getElementById('rrSliderValue').textContent = respiratoryRate;
                updateCalculations();
            });
            
            // Seleção de parâmetro
            document.getElementById('parameterSelect').addEventListener('change', function() {
                currentParameter = this.value;
                updateParameterChart();
            });
            
            // Seleção de arritmia
            document.getElementById('arrhythmiaSelect').addEventListener('change', function() {
                updateArrhythmia(this.value);
            });
            
            // Presets
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    applyPreset(this.dataset.preset);
                });
            });
        }

        // Funções de controle
        function resetSimulation() {
            // Resetar todos os parâmetros para valores normais
            heartRate = 75;
            contractility = 100;
            preload = 100;
            afterload = 100;
            fio2 = 21;
            bloodVolume = 100;
            respiratoryRate = 16;
            
            // Resetar arritmia
            document.getElementById('arrhythmiaSelect').value = 'nsr';
            updateArrhythmia('nsr');
            
            // Resetar isquemia
            document.getElementById('ischemiaToggle').classList.remove('active');
            stSegmentElevation = 0;
            
            // Resetar reflexo barorreceptor
            document.getElementById('baroreflexToggle').classList.remove('active');
            baroreflexEnabled = false;
            
            // Atualizar sliders
            document.getElementById('hrSlider').value = heartRate;
            document.getElementById('hrSliderValue').textContent = heartRate;
            
            document.getElementById('contractilitySlider').value = contractility;
            document.getElementById('contractilitySliderValue').textContent = contractility;
            
            document.getElementById('preloadSlider').value = preload;
            document.getElementById('preloadSliderValue').textContent = preload;
            
            document.getElementById('afterloadSlider').value = afterload;
            document.getElementById('afterloadSliderValue').textContent = afterload;
            
            document.getElementById('fio2Slider').value = fio2;
            document.getElementById('fio2SliderValue').textContent = fio2;
            
            document.getElementById('volumeSlider').value = bloodVolume;
            document.getElementById('volumeSliderValue').textContent = bloodVolume;
            
            document.getElementById('rrSlider').value = respiratoryRate;
            document.getElementById('rrSliderValue').textContent = respiratoryRate;
            
            // Recalcular valores
            updateCalculations();
            updateBeatInterval();
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? 'Continuar' : 'Pausar';
            
            if (!isPaused) {
                startAnimation();
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').classList.toggle('active');
        }

        function toggleBaroreflex() {
            baroreflexEnabled = !baroreflexEnabled;
            document.getElementById('baroreflexToggle').classList.toggle('active');
        }

        function toggleIschemia() {
            const isActive = document.getElementById('ischemiaToggle').classList.toggle('active');
            stSegmentElevation = isActive ? 0.2 : 0;
            
            if (isActive) {
                // Reduzir SpO2 e contractilidade em caso de isquemia/hipóxia
                fio2 = Math.max(10, fio2 - 10);
                contractility = Math.max(50, contractility - 20);
                
                document.getElementById('fio2Slider').value = fio2;
                document.getElementById('fio2SliderValue').textContent = fio2;
                
                document.getElementById('contractilitySlider').value = contractility;
                document.getElementById('contractilitySliderValue').textContent = contractility;
            }
            
            updateCalculations();
        }

        // Funções de cálculo fisiológico
        function updateCalculations() {
            // Cálculo do volume sistólico (VS) baseado em pré-carga, contractilidade e pós-carga
            strokeVolume = 70 * (preload / 100) * (contractility / 100) * (100 / afterload);
            strokeVolume = Math.max(20, Math.min(150, strokeVolume)); // Limitar valores fisiológicos
            
            // Cálculo do débito cardíaco (DC = FC × VS)
            cardiacOutput = (heartRate * strokeVolume) / 1000; // L/min
            
            // Cálculo da resistência vascular sistêmica (RVS)
            systemicVascularResistance = (meanArterialPressure / cardiacOutput) * (afterload / 100);
            systemicVascularResistance = Math.max(5, Math.min(30, systemicVascularResistance));
            
            // Cálculo da pressão arterial média (MAP ≈ DC × RVS)
            meanArterialPressure = cardiacOutput * systemicVascularResistance;
            meanArterialPressure = Math.max(40, Math.min(150, meanArterialPressure));
            
            // Estimativa de PAS e PAD baseado no MAP
            systolicBP = meanArterialPressure + (meanArterialPressure - diastolicBP) / 2;
            diastolicBP = meanArterialPressure - (systolicBP - meanArterialPressure) / 2;
            
            // Limites fisiológicos
            systolicBP = Math.max(60, Math.min(250, systolicBP));
            diastolicBP = Math.max(30, Math.min(150, diastolicBP));
            
            // Cálculo da SpO2 baseado na FiO2
            if (fio2 >= 21) {
                spo2 = 95 + (fio2 - 21) / 4;
            } else {
                spo2 = 80 + (fio2 - 10) * 1.5;
            }
            spo2 = Math.max(70, Math.min(100, spo2));
            
            // Aplicar reflexo barorreceptor se ativado
            if (baroreflexEnabled) {
                // Se a pressão arterial está alta, diminuir a frequência cardíaca
                if (meanArterialPressure > 100) {
                    heartRate = Math.max(50, heartRate - 1);
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                }
                // Se a pressão arterial está baixa, aumentar a frequência cardíaca
                else if (meanArterialPressure < 70) {
                    heartRate = Math.min(150, heartRate + 1);
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                }
            }
            
            // Atualizar valores na interface
            document.getElementById('hrValue').textContent = heartRate;
            document.getElementById('bpValue').textContent = `${Math.round(systolicBP)}/${Math.round(diastolicBP)}`;
            document.getElementById('mapValue').textContent = Math.round(meanArterialPressure);
            document.getElementById('spo2Value').textContent = Math.round(spo2);
            document.getElementById('rrValue').textContent = respiratoryRate;
        }

        // Funções de arritmia
        function updateArrhythmia(type) {
            irregularRhythm = false;
            irregularityFactor = 0;
            avDelay = 150; // Resetar para valor normal
            
            switch(type) {
                case 'nsr': // Ritmo sinusal normal
                    document.getElementById('rhythmValue').textContent = 'NSR';
                    break;
                    
                case 'sinustachy': // Taquicardia sinusal
                    document.getElementById('rhythmValue').textContent = 'Taquicardia Sinusal';
                    heartRate = 120;
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    updateBeatInterval();
                    break;
                    
                case 'sinusbrady': // Bradicardia sinusal
                    document.getElementById('rhythmValue').textContent = 'Bradicardia Sinusal';
                    heartRate = 45;
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    updateBeatInterval();
                    break;
                    
                case 'afib': // Fibrilação atrial
                    document.getElementById('rhythmValue').textContent = 'FA';
                    irregularRhythm = true;
                    irregularityFactor = 0.3;
                    heartRate = Math.floor(heartRate * 1.2); // FC geralmente mais alta na FA
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    updateBeatInterval();
                    break;
                    
                case 'aflutter': // Flutter atrial
                    document.getElementById('rhythmValue').textContent = 'Flutter Atrial';
                    irregularRhythm = true;
                    irregularityFactor = 0.1;
                    heartRate = Math.floor(heartRate * 1.1);
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    updateBeatInterval();
                    break;
                    
                case 'pvc': // Extrassístoles ventriculares
                    document.getElementById('rhythmValue').textContent = 'Extrassístoles';
                    irregularRhythm = true;
                    irregularityFactor = 0.2;
                    break;
                    
                case 'bigeminy': // Bigeminismo
                    document.getElementById('rhythmValue').textContent = 'Bigeminismo';
                    irregularRhythm = true;
                    irregularityFactor = 0.4;
                    break;
                    
                case 'vtach': // Taquicardia ventricular
                    document.getElementById('rhythmValue').textContent = 'TV';
                    heartRate = 180;
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    updateBeatInterval();
                    break;
                    
                case 'avblock1': // Bloqueio AV 1º grau
                    document.getElementById('rhythmValue').textContent = 'BAV 1º';
                    avDelay = 250; // Prolongado
                    break;
                    
                case 'avblock2': // Bloqueio AV 2º grau
                    document.getElementById('rhythmValue').textContent = 'BAV 2º';
                    irregularRhythm = true;
                    irregularityFactor = 0.5;
                    avDelay = 300; // Muito prolongado
                    break;
                    
                case 'avblock3': // Bloqueio AV 3º grau
                    document.getElementById('rhythmValue').textContent = 'BAV 3º';
                    heartRate = 40; // Ritmo de escape ventricular
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    updateBeatInterval();
                    break;
            }
            
            updateCalculations();
        }

        // Funções de preset
        function applyPreset(preset) {
            switch(preset) {
                case 'normal':
                    resetSimulation();
                    break;
                    
                case 'tachy':
                    heartRate = 150;
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    document.getElementById('arrhythmiaSelect').value = 'sinustachy';
                    updateArrhythmia('sinustachy');
                    break;
                    
                case 'brady':
                    heartRate = 40;
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    document.getElementById('arrhythmiaSelect').value = 'sinusbrady';
                    updateArrhythmia('sinusbrady');
                    break;
                    
                case 'afib':
                    heartRate = 120;
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    document.getElementById('arrhythmiaSelect').value = 'afib';
                    updateArrhythmia('afib');
                    break;
                    
                case 'vtach':
                    heartRate = 180;
                    systolicBP = 80;
                    diastolicBP = 50;
                    meanArterialPressure = 60;
                    document.getElementById('hrSlider').value = heartRate;
                    document.getElementById('hrSliderValue').textContent = heartRate;
                    document.getElementById('arrhythmiaSelect').value = 'vtach';
                    updateArrhythmia('vtach');
                    break;
                    
                case 'hypovolemia':
                    bloodVolume = 60;
                    preload = 50;
                    systolicBP = 90;
                    diastolicBP = 60;
                    meanArterialPressure = 70;
                    document.getElementById('volumeSlider').value = bloodVolume;
                    document.getElementById('volumeSliderValue').textContent = bloodVolume;
                    document.getElementById('preloadSlider').value = preload;
                    document.getElementById('preloadSliderValue').textContent = preload;
                    updateCalculations();
                    break;
                    
                case 'hypoxia':
                    fio2 = 15;
                    document.getElementById('fio2Slider').value = fio2;
                    document.getElementById('fio2SliderValue').textContent = fio2;
                    document.getElementById('ischemiaToggle').classList.add('active');
                    stSegmentElevation = 0.2;
                    updateCalculations();
                    break;
            }
        }

        // Funções de áudio
        function updateBeatInterval() {
            beatInterval = 60000 / heartRate; // ms por batimento
        }

        function playHeartBeat(time) {
            if (!soundEnabled) return;
            
            // Tocar S1
            s1Sound(time);
            
            // Tocar S2 após um intervalo
            const s2Time = time + beatInterval * 0.3; // S2 ocorre a ~30% do ciclo cardíaco
            s2Sound(s2Time);
        }

        // Funções de gráfico
        function generateECGPoint(position) {
            // position: 0 a 1, onde 0 é o início do ciclo e 1 é o fim
            
            // Onda P: 0.0 a 0.15
            // Complexo QRS: 0.15 a 0.25
            // Onda T: 0.3 a 0.6
            
            let value = 0;
            
            // Onda P
            if (position >= 0.0 && position < 0.15) {
                const pPosition = (position - 0.0) / 0.15;
                value = 0.15 * Math.sin(Math.PI * pPosition);
            }
            
            // Segmento PR
            else if (position >= 0.15 && position < 0.18) {
                value = 0;
            }
            
            // Complexo QRS
            else if (position >= 0.18 && position < 0.25) {
                const qrsPosition = (position - 0.18) / 0.07;
                
                if (qrsPosition < 0.2) {
                    // Onda Q
                    value = -0.2 * Math.sin(Math.PI * qrsPosition / 0.2);
                } else if (qrsPosition < 0.5) {
                    // Onda R
                    value = 1.0 * Math.sin(Math.PI * (qrsPosition - 0.2) / 0.3);
                } else {
                    // Onda S
                    value = -0.3 * Math.sin(Math.PI * (qrsPosition - 0.5) / 0.5);
                }
            }
            
            // Segmento ST
            else if (position >= 0.25 && position < 0.3) {
                value = stSegmentElevation; // Elevação do ST em caso de isquemia
            }
            
            // Onda T
            else if (position >= 0.3 && position < 0.6) {
                const tPosition = (position - 0.3) / 0.3;
                value = 0.25 * Math.sin(Math.PI * tPosition);
            }
            
            // Linha de base
            else {
                value = 0;
            }
            
            return value;
        }

        function generateBPPoint(position) {
            // position: 0 a 1, onde 0 é o início do ciclo e 1 é o fim
            
            // Curva de pressão arterial: pico sistólico seguido por queda diastólica
            
            let value = diastolicBP;
            
            // Pico sistólico
            if (position >= 0.0 && position < 0.2) {
                const sysPosition = position / 0.2;
                value = diastolicBP + (systolicBP - diastolicBP) * Math.sin(Math.PI * sysPosition);
            }
            // Queda diastólica
            else if (position >= 0.2 && position < 0.8) {
                const diasPosition = (position - 0.2) / 0.6;
                value = systolicBP - (systolicBP - diastolicBP) * Math.sin(Math.PI * diasPosition / 2);
            }
            // Diástole final
            else {
                value = diastolicBP;
            }
            
            return value;
        }

        function generateSpO2Point(position) {
            // SpO2 é relativamente estável com pequenas variações respiratórias
            
            let value = spo2;
            
            // Pequenas variações relacionadas à respiração
            if (position >= 0.0 && position < 0.5) {
                value += 0.5 * Math.sin(Math.PI * position * 2);
            }
            else {
                value -= 0.5 * Math.sin(Math.PI * (position - 0.5) * 2);
            }
            
            return value;
        }

        function generateRRPoint(position) {
            // Forma de onda da frequência respiratória
            
            let value = 0;
            
            // Inspiração
            if (position >= 0.0 && position < 0.4) {
                const inspPosition = position / 0.4;
                value = 100 * Math.sin(Math.PI * inspPosition);
            }
            // Expiração
            else if (position >= 0.4 && position < 0.8) {
                const expPosition = (position - 0.4) / 0.4;
                value = 100 * (1 - Math.sin(Math.PI * expPosition / 2));
            }
            // Pausa
            else {
                value = 0;
            }
            
            return value;
        }

        function updateECGChart(timestamp) {
            // Calcular posição no ciclo cardíaco
            const cyclePosition = ((timestamp % beatInterval) / beatInterval);
            
            // Adicionar irregularidade se necessário
            let adjustedPosition = cyclePosition;
            if (irregularRhythm) {
                const randomFactor = (Math.random() - 0.5) * irregularityFactor;
                adjustedPosition = Math.max(0, Math.min(1, cyclePosition + randomFactor));
            }
            
            // Gerar ponto ECG
            const ecgValue = generateECGPoint(adjustedPosition);
            
            // Atualizar dados
            ecgData.push(ecgValue);
            if (ecgData.length > 100) {
                ecgData.shift();
            }
            
            // Atualizar gráfico
            ecgChart.data.datasets[0].data = [...ecgData];
            ecgChart.update('none');
            
            // Tocar som do batimento cardíaco
            if (timestamp >= nextBeatTime) {
                playHeartBeat(timestamp / 1000);
                
                // Calcular próximo batimento com irregularidade se necessário
                let nextInterval = beatInterval;
                if (irregularRhythm) {
                    const randomFactor = (Math.random() - 0.5) * irregularityFactor * beatInterval;
                    nextInterval = Math.max(200, Math.min(2000, beatInterval + randomFactor));
                }
                
                nextBeatTime = timestamp + nextInterval;
            }
        }

        function updateParameterChart(timestamp) {
            // Calcular posição no ciclo cardíaco
            const cyclePosition = ((timestamp % beatInterval) / beatInterval);
            
            let value;
            
            switch(currentParameter) {
                case 'bp':
                    value = generateBPPoint(cyclePosition);
                    break;
                case 'spo2':
                    value = generateSpO2Point(cyclePosition);
                    break;
                case 'rr':
                    // Ciclo respiratório é mais lento que o cardíaco
                    const respCyclePosition = ((timestamp % (60000 / respiratoryRate)) / (60000 / respiratoryRate));
                    value = generateRRPoint(respCyclePosition);
                    break;
                default:
                    value = 0;
            }
            
            // Atualizar dados
            switch(currentParameter) {
                case 'bp':
                    bpData.push(value);
                    if (bpData.length > 100) {
                        bpData.shift();
                    }
                    parameterChart.data.datasets[0].data = [...bpData];
                    break;
                case 'spo2':
                    spo2Data.push(value);
                    if (spo2Data.length > 100) {
                        spo2Data.shift();
                    }
                    parameterChart.data.datasets[0].data = [...spo2Data];
                    break;
                case 'rr':
                    rrData.push(value);
                    if (rrData.length > 100) {
                        rrData.shift();
                    }
                    parameterChart.data.datasets[0].data = [...rrData];
                    break;
            }
            
            // Atualizar gráfico
            parameterChart.update('none');
        }

        function updateParameterChart() {
            // Atualizar título e cor do gráfico com base no parâmetro selecionado
            const chartTitle = document.querySelector('.chart-header .chart-title');
            
            switch(currentParameter) {
                case 'bp':
                    chartTitle.textContent = 'Pressão Arterial (mmHg)';
                    parameterChart.data.datasets[0].borderColor = '#f00';
                    parameterChart.options.scales.y.max = 200;
                    parameterChart.data.datasets[0].data = [...bpData];
                    break;
                case 'spo2':
                    chartTitle.textContent = 'SpO₂ (%)';
                    parameterChart.data.datasets[0].borderColor = '#00f';
                    parameterChart.options.scales.y.max = 100;
                    parameterChart.data.datasets[0].data = [...spo2Data];
                    break;
                case 'rr':
                    chartTitle.textContent = 'Frequência Respiratória (irpm)';
                    parameterChart.data.datasets[0].borderColor = '#ff0';
                    parameterChart.options.scales.y.max = 100;
                    parameterChart.data.datasets[0].data = [...rrData];
                    break;
            }
            
            parameterChart.update('none');
        }

        // Animação principal
        function startAnimation() {
            if (isPaused) {
                cancelAnimationFrame(animationId);
                return;
            }
            
            const animate = function(timestamp) {
                updateECGChart(timestamp);
                updateParameterChart(timestamp);
                
                animationId = requestAnimationFrame(animate);
            };
            
            animationId = requestAnimationFrame(animate);
        }
    </script>
</body>
</html>